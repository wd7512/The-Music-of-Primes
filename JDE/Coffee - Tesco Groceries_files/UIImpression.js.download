bertie.on("UIImpression",function(e){try{var productPageTrue,renderedProductIds,panelType,panelName,existingProdString,arrayOfProductIDs,impressionType=e.type,UIImpressionObj=gtmDataLayer.get("UIImpression")||{};"renderedProduct"===impressionType&&(renderedProductIds="",UIImpressionObj.busImpressionType=impressionType,UIImpressionObj.busFirstVisible=e.payload.firstVisibleItemNumber,UIImpressionObj.busLastVisible=e.payload.lastVisibleItemNumber,void 0!==e.payload.items[0]&&(UIImpressionObj.busRosSuperDepartment=e.payload.items[0].hierarchy.superDepartment,UIImpressionObj.busRosDepartment=e.payload.items[0].hierarchy.department,UIImpressionObj.busRosAisle=e.payload.items[0].hierarchy.aisle,UIImpressionObj.busAisleId=e.payload.items[0]["tesco:aisle"].aisleID,UIImpressionObj.busRenderedItemsCount=e.payload.items.length,productPageTrue=/^\/groceries\/[a-zA-Z]{2}\-[a-zA-Z]{2}\/products\/.*$/.test(location.pathname),renderedProductIds=";"+e.payload.items.map(function(item,indx){var prodVars=["","","",[],[]];item["tesco:promotion"].onPromotion?prodVars[4].push("eVar186="+item["tesco:promotion"].promotionType):prodVars[4].push("eVar186=no"),_gtm.notify("GTM: UIImpression 2.0"),item["tesco:promotion"].clubcardOffer?prodVars[4].push("eVar123=y"):prodVars[4].push("eVar123=n");var starRating,rank=productPageTrue&&!item.panelType?null:indx+1;return null!=rank&&(prodVars[3].push("event169="+rank),prodVars[4].push("eVar98="+rank)),item.numberReviews&&null!=item.numberReviews&&(_gtm.notify("GTM: UIImpression found number of reviews"),prodVars[3].push("event39="+item.numberReviews),prodVars[4].push("eVar185="+item.numberReviews)),item.starRating&&null!=item.starRating&&(_gtm.notify("GTM: UIImpression found star rating"),starRating=parseFloat(item.starRating),starRating=isNaN(starRating)?0:10*starRating,prodVars[3].push("event38="+starRating),prodVars[4].push("eVar20="+item.starRating)),item.isFav&&prodVars[4].push("eVar128=fav"),item["tesco:flags"]&&item["tesco:flags"].SUB&&item["tesco:flags"].seedLookup&&prodVars[4].push("eVar64="+item["tesco:flags"].seedLookup),prodVars[3]=prodVars[3].join("|"),prodVars[4]=prodVars[4].join("|"),UIImpressionObj.busUIImpressionRatingSet="true",productPageTrue&&!UIImpressionObj.gaPdpProdId&&void 0===e.payload.items[0].panelType&&(UIImpressionObj.gaPdpProdId=item.productID),item.productID+prodVars.join(";")}).join(",;"),_gtm.notify("BERTIE Rendered Product Ids (UIImpression DCR):"+renderedProductIds),_gtm.notify("GTM: UIImpression 3.0"),panelType=e.payload.items[0].panelType,panelName=e.payload.items[0].panelName,existingProdString=UIImpressionObj.busRenderedProdViewString,_gtm.notify("GTM: -- not promotions",panelType),"dhPromotion"!=panelType?(_gtm.notify("GTM: not promotions"),"sugProduct"!=panelType?(UIImpressionObj.fbArrayOfProducts=e.payload&&e.payload.items&&e.payload.items.length?e.payload.items:"",existingProdString&&"favourites"!==panelType&&(UIImpressionObj.busRenderedProdViewString=existingProdString+","+renderedProductIds),/\/groceries(\/(-?[a-zA-Z]{2}){2})?\/?$/.test(location.pathname)&&"favourites"==panelType?UIImpressionObj.favProdViewString=renderedProductIds:"carousel1"==panelType?(_gtm.notify("GTM: if 2.1.2"),UIImpressionObj.carousel1ProdViewString=renderedProductIds):"carousel2"==panelType?(_gtm.notify("GTM: if 2.1.2"),UIImpressionObj.carousel2ProdViewString=renderedProductIds):"carousel3"==e.payload.items[0].panelType?(_gtm.notify("GTM: if 2.1.2"),UIImpressionObj.carousel3ProdViewString=renderedProductIds):"frequently bought"==e.payload.items[0].panelType?(_gtm.notify("GTM: if 2.1.3"),UIImpressionObj.freqbProdViewString=renderedProductIds):(_gtm.notify("GTM: if 2.1.4"),gtmDataLayer.set("UIImpression.busRenderedProdViewString",renderedProductIds),gtmDataLayer.set("UIImpression.busUIImpressionRatingSet",UIImpressionObj.busUIImpressionRatingSet),gtmDataLayer.set("UIImpression.productID",e.payload.items[0].productID))):"sugProduct"==panelType&&(_gtm.notify("GTM: if 2.1.4"),UIImpressionObj.trexProdViewString=renderedProductIds),_gtm.notify("BERTIE DATA ELEMENT busRenderedProdViewString: ",UIImpressionObj.busRenderedProdViewString),"grid"==panelType&&(UIImpressionObj.gridProductArray=e.payload.items),_gtm.notify("GTM: panelType1 is "+panelType),"favourites"!=panelType&&"hyf"!=panelType&&"carousel1"!=panelType&&"carousel2"!=panelType&&"carousel3"!=panelType&&"frequently bought"!=panelType||(_gtm.notify("GTM: if 3.0"),_gtm.notify("GTM: panelType2 is "+panelType),"hyf"==panelType&&(_gtm.notify("GTM: if 3.1"),UIImpressionObj.hyfProdViewString=renderedProductIds),"favourites"==panelType&&(_gtm.notify("GTM: if 3.2"),UIImpressionObj.favProductArray=e.payload.items),"frequently bought"==panelType&&(_gtm.notify("GTM: if 3.3"),UIImpressionObj.freqbProductArray=e.payload.items),setTimeout(function(){var panelValue="carousel1"==panelType||"carousel2"==panelType||"carousel3"==panelType?panelType+":"+panelName:panelType;gtmDataLayer.set("UIImpression.busRenderedCarouselPanelType",panelValue),cookieBannerAvailable&&!expCookieTrue||gtmDataLayer.get("customEventSetVars.favCarouselAA")()},700)),gtmDataLayer.set("UIImpression",UIImpressionObj),"sugProduct"!=e.payload.items[0].panelType&&(gtmDataLayer.set("UIImpression.productIDGtin",e.payload.items[0].gtin13),arrayOfProductIDs=e.payload.items&&e.payload.items.length?e.payload.items.map(function(x){return x["@id"]}):null,gtmDataLayer.set("UIImpression.marketingProductIds",arrayOfProductIDs))):"dhPromotion"==panelType&&(_gtm.notify("GTM: its RSP"),UIImpressionObj.hyfProdViewString=renderedProductIds,gtmDataLayer.set("UIImpression",UIImpressionObj),setTimeout(function(){var panelValue="carousel1"==panelType||"carousel2"==panelType||"carousel3"==panelType?panelType+":"+panelName:panelType;gtmDataLayer.set("UIImpression.busRenderedCarouselPanelType",panelValue),cookieBannerAvailable&&!expCookieTrue||gtmDataLayer.get("customEventSetVars.favCarouselAA")()},700))))}catch(e){var errorsObj=gtmDataLayer.get("errors")||{};errorsObj.UIImpression="Unavailable",errorsObj.UIImpression.eMesssage=e,gtmDataLayer.set("errors",errorsObj)}});