bertie.on("trolleyData",function(e){try{var UIStartTimePos,UIStartTime,UIEndTimePos,UIEndTime,slotValue,startHour,delivMethodFull,stringToSend=[],hasWeightedProd=!1,unitsPerProd=[],totalItemsCount=0,marketingProductIds=[],marketingProductIdsToSend=[],gaConversionProdString=[],payMethod=e.paymentMode||null,delivMethod=e.bookedSlot.method||null,guidePrice=e.guidePrice?parseFloat(e.guidePrice).toFixed(2):0,totalPrice=e.totalPrice||null,delivCharge=e.bookedSlot.charge.price||null,orderIdNumber=e.orderNumber||null,productCount=e.items.length||null,slotStart=e.bookedSlot.start||null,slotEnd=e.bookedSlot.end||null,deliverLeadTime="",bagOption=e.bagOption,trolleyDataObj={};if("lightdelivery"==delivMethod&&(delivMethod="on demand"),payMethod)switch(payMethod){case"PaymentOnline":payMethod="standard card";break;case"PaymentDoorCard":payMethod="pay at door"}slotStart&&slotEnd&&(UIStartTimePos=slotStart.indexOf("T",0),UIStartTime=slotStart.substring(UIStartTimePos+1,UIStartTimePos+6),UIEndTimePos=slotEnd.indexOf("T",0),UIEndTime=slotEnd.substring(UIEndTimePos+1,UIEndTimePos+6),slotValue=slotStart.substring(0,10).replace(/-/g,"")+"-"+UIStartTime+"-"+UIEndTime,startHour=UIStartTime.substring(0,2),delivMethodFull=delivMethod+" "+(UIEndTime.substring(0,2)-startHour)+" hour",slotStart&&(deliverLeadTime=Math.floor(new Date(slotStart)/864e5)-Math.floor(new Date/864e5)+"|"+(Math.floor(new Date(slotStart)/36e5)-Math.floor(new Date/36e5))).match(/^\d+\|\d+$/)&&(trolleyDataObj.trolleyDataSlotLeadTime=deliverLeadTime));var couponDiscountCalc,couponDiscountTotal,couponCount,couponAction,couponDiscount,couponType,couponCode,noOfCoupons=0;e.couponState&&(noOfCoupons=e.couponState.length||null),0<noOfCoupons&&(couponDiscountTotal=[],couponCount=1,e.couponState.forEach(function(coupon){couponAction=coupon.action||null,couponDiscount=coupon.discount||null,couponDiscountTotal.push(couponDiscount),couponType=coupon.discountType||null,couponCode=coupon.couponCode||null}),1<e.couponState.length&&(couponType=couponCode="multiple",couponCount=e.couponState.length||null,couponDiscountCalc=couponDiscountTotal.reduce(function add(a,b){return a+b},0),couponDiscount=couponDiscountCalc),trolleyDataObj.trolleyDataCouponsInOrder="y",trolleyDataObj.trolleyDataCouponCount=couponCount,trolleyDataObj.trolleyDataCouponDiscount=couponDiscount,trolleyDataObj.trolleyDataCouponType=couponType,trolleyDataObj.trolleyDataCouponCode=couponCode,trolleyDataObj.trolleyDataCouponAction=couponAction),e.items.forEach(function(item){var prodMeth,productInfo=[],isFav=item.isFav;switch(item.priceBreakdown&&item.priceBreakdown.unitOfMeasure||"empty"){case"pcs":prodMeth="q";break;case"kg":prodMeth="w";break;default:prodMeth="u"}var perUnitWeight,prodQty=item.qty,prodRev=parseFloat(item.price.price).toFixed(2),aTotalWeight=parseFloat(item.weight).toFixed(2);"w"==prodMeth&&(perUnitWeight=parseFloat(aTotalWeight/prodQty).toFixed(2),hasWeightedProd=!0),gaConversionProdString.push({id:item.tpnb,quantity:prodQty,price:prodRev}),productInfo.push(null,item.tpnb,prodQty,prodRev,"w"===prodMeth?"event154="+aTotalWeight:null),marketingProductIds.push(item.tpnb);var evarStr="evar130="+prodMeth;evarStr+="w"===prodMeth?"|eVar135="+aTotalWeight+"|eVar134="+perUnitWeight:"",evarStr+=isFav?"|evar128=fav":"";var onPromotion=item["tesco:promotion"].onPromotion||null,promotionType=item["tesco:promotion"].promotionType||null;evarStr+=onPromotion?"|eVar186="+promotionType:"|eVar186=no",evarStr+=item["tesco:promotion"].clubcardOffer||null?"|eVar123=y":"|eVar123=n",productInfo.push(evarStr),stringToSend.push(productInfo.join(";")),unitsPerProd.push(prodQty),totalItemsCount=unitsPerProd.reduce(function add(a,b){return a+b},0),_gtm.notify("GTM: ---totalItemsCount--",totalItemsCount)}),marketingProductIdsToSend.push(marketingProductIds.join(",")),trolleyDataObj.busTrolleyData=e.items,trolleyDataObj.bagOption=bagOption,trolleyDataObj.trolleyDataTotalItemsCount=totalItemsCount,trolleyDataObj.trolleyDataDelivMethod=delivMethodFull,trolleyDataObj.trolleyDataDelivCharge=delivCharge,trolleyDataObj.trolleyDataPayMethod=payMethod,trolleyDataObj.trolleyDataGuidePrice=guidePrice,trolleyDataObj.trolleyDataProductString=stringToSend.join(","),trolleyDataObj.trolleyDataHasWeightedProduct=hasWeightedProd,trolleyDataObj.trolleyDataOrderIDNumber=orderIdNumber,trolleyDataObj.trolleyDataProdCount=productCount,trolleyDataObj.trolleyDataSlotTime=slotValue,trolleyDataObj.trolleyDataTotalPrice=totalPrice,trolleyDataObj.trolleyDataGaConversionProdStr=gaConversionProdString,trolleyDataObj.trolleyDataMarketingProductString=marketingProductIdsToSend,trolleyDataObj.trolleyDataSlotStart=slotStart,gtmDataLayer.set("trolleyData",trolleyDataObj)}catch(e){var errorsObj=gtmDataLayer.get("errors")||{};errorsObj.trolleyData="Unavailable",errorsObj.trolleyData.eMesssage=e,gtmDataLayer.set("errors",errorsObj)}});